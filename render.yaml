services:
  - type: web
    name: garage
    runtime: python
    region: oregon
    plan: free
    rootDir: Garage
    buildCommand: >-
      pip install -r requirements.txt &&
      curl -fsSL https://download.java.net/java/GA/jdk17.0.2/dfd4a8d0985749f896bed50d7138ee7f/8/GPL/openjdk-17.0.2_linux-x64_bin.tar.gz -o /tmp/jdk17.tar.gz &&
      mkdir -p /opt/render/project/jdk17 &&
      tar -xzf /tmp/jdk17.tar.gz -C /opt/render/project/jdk17 --strip-components=1 &&
      /opt/render/project/jdk17/bin/javac -version
    startCommand: >-
      export JAVA_HOME=/opt/render/project/jdk17 &&
      export PATH=/opt/render/project/jdk17/bin:$PATH &&
      uvicorn app.main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      - key: JWT_SECRET_KEY
        sync: false  # Configure manually in Render dashboard
      - key: DATABASE_URL
        sync: false  # Configure manually in Render dashboard
      - key: OPENAI_API_KEY
        sync: false  # Configure manually in Render dashboard
      - key: OPENAI_MODEL
        value: "gpt-4.1-mini"  # Default model
      - key: OPENAI_FALLBACK_MODELS
        value: "gpt-4.1-mini,gpt-4.1,gpt-4o"  # Fallback chain
      - key: GROQ_API_KEY
        sync: false  # Configure manually in Render dashboard
      - key: GROQ_MODEL
        value: "llama-3.3-70b-versatile"  # Groq free: 14400 req/day
      - key: AI_CHAT_MAX_TOKENS
        value: "1200"  # Max tokens for study chat responses
      - key: JAVA_COMPILE_TIMEOUT
        value: "15"  # seconds — javac wall-clock limit
      - key: JAVA_RUN_TIMEOUT
        value: "10"  # seconds — java process wall-clock limit
      - key: JAVA_HOME
        value: "/opt/render/project/jdk17"
        # buildCommand baixa OpenJDK 17 para /opt/render/project/jdk17 (path gravavel no Render).
        # startCommand exporta JAVA_HOME e PATH antes de iniciar uvicorn.
        # _find_java_binary() usa JAVA_HOME (layer 1) como resolver principal.
      - key: ADMIN_USERNAME
        sync: false  # Configure manually in Render dashboard
      - key: ADMIN_EMAIL
        sync: false  # Configure manually in Render dashboard
